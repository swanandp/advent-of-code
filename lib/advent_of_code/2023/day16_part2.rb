def sample_input
  <<~INPUT
    .|...\\....
    |.-.\\.....
    .....|-...
    ........|.
    ..........
    .........\\
    ..../.\\\\..
    .-.-/..|..
    .|....-|.\\
    ..//.|....
  INPUT
end

def print_tiles(tiles)
  puts "++++++++++++++++"

  tiles.each do |row|
    row.each { |col| print(col) }
    puts ""
  end

  puts "++++++++++++++++"
end

def print_energy_map(energized)
  puts "++++++++++++++++"

  energized.each do |row|
    row.each { |col|
      print(col.keys.empty? ? "." : "#")
    }

    puts ""
  end

  puts "++++++++++++++++"
end

def count_energy(energized)
  energized.sum do |row|
    row.sum { |col| col.keys.empty? ? 0 : 1 }
  end
end

def next_cell(curr, i, j, len_i, len_j)
  @dir ||= {
    north: [-1, 0],
    south: [1, 0],
    east: [0, 1],
    west: [0, -1],
  }

  next_i = i + @dir.dig(curr, 0)
  next_j = j + @dir.dig(curr, 1)

  if 0 <= next_i && next_i < len_i && 0 <= next_j && next_j < len_j
    [next_i, next_j]
  else
    false # explicit false, so can be handled better downstream
  end
end

def mirror?(cell)
  @mx ||= /\A[|\-\\\/]\z/
  @mx =~ cell
end

# noinspection RubyLiteralArrayInspection
def split_into(curr, mirror)
  @split_into ||= {
    north: {
      "|" => [:north],
      "-" => [:east, :west],
      "\\" => [:west],
      "/" => [:east],
    },
    south: {
      "|" => [:south],
      "-" => [:east, :west],
      "\\" => [:east],
      "/" => [:west],
    },
    east: {
      "|" => [:north, :south],
      "-" => [:east],
      "\\" => [:south],
      "/" => [:north],
    },
    west: {
      "|" => [:north, :south],
      "-" => [:west],
      "\\" => [:north],
      "/" => [:south],
    },
  }

  @split_into.dig(curr, mirror)
end

def energize(tiles, energized, beams = [])
  return if beams.empty?

  beams.each do |beam|
    dir, i, j = beam
    cell = tiles[i][j]

    if energized.dig(i, j, dir).nil?
      energized[i][j][dir] = 1
      # print_energy_map(energized)
    else
      next
    end

    if mirror?(cell)
      new_beams = split_into(dir, cell).map { |d|
        split_i, split_j = next_cell(d, i, j, tiles.length, tiles[i].length)

        if split_j
          [d, split_i, split_j]
        end
      }.compact

      energize(tiles, energized, new_beams)
    else
      next_i, next_j = next_cell(dir, i, j, tiles.length, tiles[i].length)

      if next_j
        energize(tiles, energized, [[dir, next_i, next_j]])
      end
    end
  end
end

def starting_beams(max_i, max_j)
  [0].product(0.upto(max_j).to_a).map { |(r, c)| [:south, r, c] } +
    [max_i].product(0.upto(max_j).to_a).map { |(r, c)| [:north, r, c] } +
    0.upto(max_i).to_a.product([0]).map { |(r, c)| [:east, r, c] } +
    0.upto(max_i).to_a.product([max_j]).map { |(r, c)| [:west, r, c] }
end

def solve(input)
  tiles = input.split("\n").map { |l| l.strip.split("") }

  starting_beams(tiles.length - 1, tiles.first.length - 1).map do |beam|
    energized = tiles.map { |l| l.map { |_| Hash.new } }
    energize(tiles, energized, [beam])
    count_energy(energized)
  end.max
end

pp solve(sample_input)
pp solve(DATA.read)

__END__
\\.........../..............-..../....\.......\.................|....|..........|............-\.....|.........
................................../.......|..\..........-....................\........../../\../..............
.............................|...|.............\..\.....|.........\....................../............/-......
\................\.............|..../........\\.....\\........-.........../..\.../...\.......\/.......|..|....
......\..............|...|..../........-../.................../....|./................./.\........\.|-........
.............................-....................-............/.\............../........\/........|...\......
./........|................\.|........\.......\../.-.........\..-.............|...............................
|....................|...............-/............-.|..|...........................|..................\......
................../........\../...........|..................\................./.......\...-......../|........
././...........-..|....................................-.....................|./........../..|.-..\..|.....|..
.............|.......................||................................../..-........./.................../...
........-......\............/.....-...\..|...........\..........-.........................\...................
\/...............\.|......................\......\.........\/..........\................./.-.../...-.....|....
....\........................................................\.......-/.............\/.........\..............
\........\.........\..\..|....\..............-...../.................|.....|.................\.-/.............
.............................\/..-..............\....-...-............................................./......
....|..../...................//.........\.............\......|...|....../............|.......-.|.-.-|.......\.
.........|..-.-........\\../...........|.....\............................../....\\..\......../......\\..|....
.......|....................-...././...../.|../........................./...-\...|.......|.......-....|......\
../.../........-......................|......-.....\..............-../.......|./.......|.............|.......|
........................................................./............-......\.../........\../../.........\...
........................./../.../............-.\.........................|..............|....................|
..-......./.--.......|.............................................\........\.........\...............\......|
.|........................................|..........-....\.......\.......|................................../
..............................................\.....\........|.....\./......\................|......../...../.
./.\......../..\\..|....-.-|..-.............................................../.\|/........\.........-|...|...
........|........-.\/................-.........-............../.|..........\./|...--...............|..........
.................-............./././...........|.|.....|....|......\-....|...............|....................
.......././..............................................|/...\........../......./..||.\..-...................
............-..|....................\..-./.........\..........................................................
./.-...............\......\...|......\....../..........................-....................-...|......\......
.....././...-........................\..../..|-.............../.......................................\|......
-.........................................../...............-....../.....|.........\..-.........|.............
....|.......\....\|.....\.|....|.............\..\...-............../.....................\....-...............
.............-..-..................\..............|..|........................-..........\../.\......../......
.....|.....................\.....\.......\...........\....|.........\.......//.................|........./....
|.....\-/.......|............../.....\..........|......./......./...............\./..........|................
............../|.......................|....../..............-...................-...................../......
../|....\.......\...............\................-........\..../../.................\/.........\....\.........
........-.....|.|......-...........\............|...................\...........|.......................|.....
.....|....|..\..........................|................\..../....-..................................|.......
..-........||/................/........|......................-....-..................../..|...../............
............./.............\..-.......................\..................||.-.-..|...............\...|...\....
............................\....\....../....\...........-...................|....-.....|.....................
.../...........................-..|.....|../.........\./.................\|..............||....|..........\...
.................../........\...........\........../............|...|\....\........|......-...\.......|./...\.
-....|...........\............./..\...........||...................|.............../...............\..........
.........\.........-..................../.../.......//.............-/...-.-|....\.............................
..-.........\......././................-.........|-...../............|....-.............\.....................
......../.......|.............................\....|......................../................................-
..\........./.--................/................................................................../......-...
.../................|.\....-.................................\.../....................................\.......
.............................\....../.|...........-............................................/....-.........
...\./..........-........./../...............................-..-........-....../..................-.....\....
.........\........./\........................-.-................................|.............................
..../.|-.................................-............\..................|.........|......./......-...........
.-|..........................-........|...//..\.../.........-............/|.............|..............-..\...
..../......|...\..........|...........-.||....-..|.........-......../..........|................../...........
\.../../............./../...........\...........\.......................................\./.............|.....
.....|.../....|..............................\........\...................|.........|.........................
..........|............|............./......../.../................................-.....-.........../..|.....
......-.\.........................|...../.....\.....-/....-..|.\.........\|....-.........||...........\.......
..\......\............./...............\-............/...|................................/...................
.......|.|...|.|.........|..|.......-...\.........|./..|..................-................|..........-.......
..-\...--..-........|......................-.....|./..............|/.................../...........\....-.../.
...........-...-........-..........-...........|.......-................\.........|............-.............|
.....|.\..-../....\.................../-....\.............|......../....\/.\..\...//..........|...............
......-.-.|..|............................./.........-....|.......|......|..............................-...-.
..|............\...|................./\...|........../...-.|.........\..../.........|-...|.......\...........-
...................\..../..............|...../.....\....../.................\..|.....................-........
.|............-................../........-.....|..../..........................|../..\.....\....|............
.............................................|..........|......-\.............-..-........................\...
............./.-....|......|................................................-/|/...|../...........-...|.......
......-................-..-...............|................-.-.............\........|...-./................-..
...........|...........-/........../..................../|.|...................|...................../........
.....................................\......................../...........|-...........-................../...
...|.....\.....-...../..............|.........\....\............-\............\/.........................-....
..............-\......-.............../...|.........................................|.....\/..................
.................|...|.....|.............../....\...............-....\..........|.-........|........../...|...
..|...-.........\....-.....\.....................|...|.......-....\....-..-......-.\../........-../...........
.......\.....\................\......\-................................|..\.....//.........../..........\.....
........................../.-.................................\--......../..-.................................
.................|............|\./....|.|..|.............//......./.......................|.....\.....\\......
./...|\...................................../.......................\.........|..............|....|....\......
......|.............................................................\..|.................\-..../......./......
.....-.......|........../......./..\...........|...........-..|......../...../................\......\........
............\....-........\......./.......-...........................................\........-/./...........
|..................................-.........\/..-....././.....\.............../-....................\........
../.........-..........-....-...-.........\/....................../.../.....\............................-.\.|
........../...-..-........................-........................................./....\.....-..............
..|-.\........\....................\.\..........-....|.-.-...........\..............\..-.....|................
..-.../......./\.\...\\.//.....|..........................\........|.-||......................|.......\/......
...-........-/.............................-......................-|....\...|..../..|.........\...............
.........|..|/........./.......\....\../\.-..-...\..|...../...........\.............../..................../\.
.........\.-\|..|../...........--..........|-......|...|.................||...................................
..................\.....\...........................|.............\..|.........................|...........\..
....|../........../.............................|./........\\.....|.....|...................................|.
-..........................................-........................-...\..................\.....\......-.....
..\.\......|......|........|.............-|....-.....-...........|../.-.........|........\..\...-...\........\
.|.......-..|....|..............|.................../...............|.............................-.........//
....................\..\.||./\.......-.........-..-................../..../....................-/..........\..
.........\.........|...-.....\..........\.\....|.|..............|..........................................\.|
...|\..|................-/..........|\....\/|..-...........................................\..................
.../...\.|..............................\.-...\.........\....../../...............-./............/............
.....-.\..............................................\.|....................\..........|...............|.....
.....|................../|....-....-....\..../...............\.....|..|......./.................../........\..
.......................\....................-.......-.................../..............-...\..\........|......
...../................\........../..|.../...........|........|............\........-....-/.....\....|.........
.\\.\............|..................................................|......\/..........................\......
....|........../...../...-.................|......|..........-....................................../.../.....
